<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cascade: A Coop Strategy Card Game</title>
    <link rel="icon" href="{{ url_for('static', filename='images/card_game_thumbnail.png') }}" sizes="32x32" type="image/png">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/card_game_thumbnail.png') }}" sizes="32x32" type="image/png">
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
      header { background: #222; color: #fff; padding: 10px 16px; }
      nav { display: flex; align-items: center; }
      nav a { color: #fff; margin-right: 12px; text-decoration: none; }
      .container { padding: 16px; }
      .grid { display: inline-block; margin: 10px 0; }
      .row { display: flex; margin: 2px 0; }
      .cell { border: 1px solid #ccc; padding: 8px 10px; width: 48px; text-align: center; }
      .reserve { background: #f6f6f6; }
      .opponent { background: #ffe8e8; }
    </style>
  </head>
  <body>
    <header>
      <nav>
        {% if session_user %}
        <a href="/">Home</a>
        <a href="/quick">Quick Play</a>
        <a href="/ranked">Ranked</a>
        <a href="/stats">Stats</a>
        <a href="/leaderboard">Leaderboard</a>
        {% endif %}
        <span style="margin-left:auto; display:flex; align-items:center;">
          <span id="user-display" style="margin-right:8px;">{% if session_user %}Signed in as {{ session_user.display_name }}{% if session_user.user_code %} (Player ID: {{ session_user.user_code }}){% endif %}{% else %}Not signed in{% endif %}</span>
          {% if not session_user %}
          <button id="google-login-btn" style="padding:4px 8px;">Sign in with Google</button>
          {% else %}
          <button id="invites-btn" style="padding:4px 8px; display:none; margin-right:8px;">Invites</button>
          <button id="logout-btn" style="padding:4px 8px;">Sign out</button>
          {% endif %}
        </span>
      </nav>
    </header>
    <div class="container">
      {% block content %}{% endblock %}
    </div>
    <!-- Simple invites modal -->
    <div id="invite-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.4);">
      <div style="background:#fff; width: 420px; max-width: 95vw; margin: 10% auto; padding: 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">Invites</h3>
          <button id="invite-modal-close" style="padding:4px 8px;">Close</button>
        </div>
        <div id="invite-list">
          <p>No invites.</p>
        </div>
      </div>
    </div>
    <script>
      window.__FIREBASE_CONFIG__ = JSON.parse('{{ firebase_config | tojson | safe }}');
    </script>
    <script type="module">
      const cfg = window.__FIREBASE_CONFIG__ || {};
      const authDebug = (new URLSearchParams(window.location.search)).get('debugAuth') === '1' || localStorage.getItem('authDebug') === '1';
      const dlog = (...args) => { if (authDebug) console.log('[AUTH]', ...args); };
      // Surface unexpected errors in console when debugging is enabled
      if (authDebug) {
        window.addEventListener('error', (ev) => {
          console.error('[AUTH] window.onerror', ev?.message || ev);
        });
        window.addEventListener('unhandledrejection', (ev) => {
          console.error('[AUTH] unhandledrejection', ev?.reason || ev);
        });
      }

      dlog('Location', { origin: location.origin, href: location.href });
      dlog('Navigator', { userAgent: navigator.userAgent, cookieEnabled: navigator.cookieEnabled });
      dlog('Firebase config', { hasApiKey: !!cfg.apiKey, authDomain: cfg.authDomain, projectId: cfg.projectId, appId: cfg.appId });

      if (!cfg.apiKey || !cfg.projectId || !cfg.authDomain) {
        dlog('Missing required Firebase config fields. Auth will not initialize.');
      }

      if (cfg.apiKey && cfg.projectId) {
        import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js').then(({ initializeApp }) => {
          dlog('Firebase app module loaded');
          import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js').then(({ getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }) => {
            dlog('Firebase auth module loaded');
            const app = initializeApp(cfg);
            dlog('Firebase app initialized');
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            dlog('Auth provider configured');
            onAuthStateChanged(auth, (user) => {
              dlog('onAuthStateChanged', !!user, user ? { uid: user.uid, displayName: user.displayName, email: user.email } : null);
            });

            const loginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (loginBtn) {
              loginBtn.addEventListener('click', async () => {
                dlog('Login button clicked, launching popup...');
                try {
                  const res = await signInWithPopup(auth, provider);
                  dlog('Popup success', { uid: res?.user?.uid, displayName: res?.user?.displayName });
                  const idToken = await res.user.getIdToken();
                  const tokenPreview = idToken ? idToken.slice(0, 12) + '...' : null;
                  // Decode token payload for exp debugging only
                  let tokenMeta = null;
                  try {
                    const payload = JSON.parse(atob(idToken.split('.')[1]));
                    tokenMeta = { exp: payload.exp, now: Math.floor(Date.now()/1000), expiresInSec: payload.exp - Math.floor(Date.now()/1000) };
                  } catch (_) {}
                  dlog('Got ID token', { preview: tokenPreview, meta: tokenMeta });
                  const displayName = res.user.displayName || 'Player';
                  const r = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_token: idToken, display_name: displayName })
                  });
                  dlog('POST /api/login response status', r.status);
                  const j = await r.json().catch(() => null);
                  dlog('POST /api/login response body', j);
                  if (j && j.ok) {
                    location.reload();
                  } else {
                    alert('Login failed');
                  }
                } catch (e) {
                  const code = e?.code; // e.g., auth/popup-closed-by-user
                  const message = e?.message || String(e);
                  const details = e?.customData || null;
                  console.error('[AUTH] signInWithPopup error', { code, message, details });
                  if (code === 'auth/popup-blocked') {
                    alert('Popup was blocked by the browser. Please allow popups for this site.');
                  } else if (code === 'auth/popup-closed-by-user') {
                    alert('Popup closed before completing sign-in.');
                  } else if (code === 'auth/unauthorized-domain') {
                    alert('This origin is not authorized in Firebase Auth. In Firebase Console → Authentication → Settings → Authorized domains, add 127.0.0.1 and localhost.');
                  } else {
                    alert('Login popup failed');
                  }
                }
              });
            }
            if (logoutBtn) {
              logoutBtn.addEventListener('click', async () => {
                dlog('Logout button clicked');
                try {
                  await signOut(auth);
                  dlog('Firebase signOut completed');
                } catch (e) {
                  console.warn('[AUTH] signOut error', e);
                }
                const r = await fetch('/api/logout', { method: 'POST' });
                dlog('POST /api/logout status', r.status);
                location.reload();
              });
            }

            // --- Invites UX ---
            const invitesBtn = document.getElementById('invites-btn');
            const inviteModal = document.getElementById('invite-modal');
            const inviteList = document.getElementById('invite-list');
            const inviteModalClose = document.getElementById('invite-modal-close');
            let knownInviteIds = new Set();
            let invitePollTimer = null;

            function renderInvites(invites) {
              if (!inviteList) return;
              if (!invites || invites.length === 0) {
                inviteList.innerHTML = '<p>No invites.</p>';
                return;
              }
              inviteList.innerHTML = '';
              invites.forEach((inv) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.margin = '6px 0';
                const left = document.createElement('div');
                left.textContent = `${inv.inviter_display} invited you`;
                const right = document.createElement('div');
                const btn = document.createElement('button');
                btn.textContent = 'Accept';
                btn.style.padding = '4px 8px';
                btn.addEventListener('click', async () => {
                  try {
                    const r = await fetch('/api/invites/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ invite_id: inv.id }) });
                    const j = await r.json();
                    if (j && j.ok) {
                      row.remove();
                      // Redirect both players to source lobby for readying
                      const mode = j.mode || inv.mode || 'quick';
                      const dest = mode === 'ranked' ? '/ranked' : '/quick';
                      location.href = dest;
                    } else {
                      alert('Invite expired or invalid.');
                    }
                  } catch (e) {
                    alert('Failed to accept invite.');
                  }
                });
                right.appendChild(btn);
                row.appendChild(left);
                row.appendChild(right);
                inviteList.appendChild(row);
              });
            }

            async function pollInvites() {
              try {
                const r = await fetch('/api/invites/pending');
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const j = await r.json();
                const invites = (j && j.ok && Array.isArray(j.invites)) ? j.invites : [];
                if (invitesBtn) {
                  invitesBtn.style.display = invites.length > 0 ? 'inline-block' : 'none';
                  invitesBtn.textContent = invites.length > 0 ? `Invites (${invites.length})` : 'Invites';
                }
                // Detect new invites not seen before to trigger popup
                let hasNew = false;
                invites.forEach((inv) => {
                  if (!knownInviteIds.has(inv.id)) {
                    hasNew = true;
                    knownInviteIds.add(inv.id);
                  }
                });
                if (hasNew && inviteModal) {
                  renderInvites(invites);
                  inviteModal.style.display = 'block';
                }
              } catch (e) {
                // ignore
              } finally {
                invitePollTimer = setTimeout(pollInvites, 8000);
              }
            }

            if (invitesBtn && inviteModal && inviteModalClose) {
              invitesBtn.addEventListener('click', async () => {
                try {
                  const r = await fetch('/api/invites/pending');
                  const j = await r.json().catch(() => null);
                  const invites = (j && j.ok) ? j.invites : [];
                  renderInvites(invites);
                } catch (_) {
                  renderInvites([]);
                }
                inviteModal.style.display = 'block';
              });
              inviteModalClose.addEventListener('click', () => {
                inviteModal.style.display = 'none';
              });
              // Begin polling for real-time-like notifications
              pollInvites();
            }
          }).catch((err) => {
            console.error('[AUTH] Failed to load firebase-auth.js', err);
          });
        }).catch((err) => {
          console.error('[AUTH] Failed to load firebase-app.js', err);
        });
      }
    </script>
  </body>
</html>
