{% extends 'base.html' %}
{% block content %}
  <h2>Quick Play</h2>

  {% if require_login %}
    <p>You must sign in to play. Use the "Sign in with Google" button in the top-right.</p>
  {% else %}
    {% if not puzzle %}
      <form method="get" action="/quick">
        <label for="turns">Turns:</label>
        <input id="turns" name="turns" type="number" min="1" value="{{ turns_filter if turns_filter is not none else '' }}" placeholder="Random" />
        <input type="hidden" name="go" value="1" />
        <button type="submit">Go</button>
      </form>

      <div style="margin-top:12px; padding:8px; background:#f7f7f7; border:1px solid #ddd; border-radius:4px; max-width:520px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <strong>Players:</strong> <span id="players-count">{{ players_count }}</span>
          </div>
          <div>
            <button id="invite-add-btn" title="Invite by user ID code" style="padding:4px 8px;">+ Invite</button>
          </div>
        </div>
        <div id="party-list" style="margin-top:8px;">
          {% if party and party|length > 0 %}
            <ul style="margin:0; padding-left:18px;">
              <li><em>You</em></li>
              {% for m in party %}
                <li>{{ m.display_name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <!-- <p style="margin:6px 0 0 0;">Only you for now. Invite teammates with the button above.</p> -->
          {% endif %}
        </div>
        <div id="invite-msg" style="margin-top:6px; color:#333;"></div>
      </div>

      {% if active_sessions and active_sessions|length > 0 %}
        <h3 style="margin-top:18px;">Resume a puzzle</h3>
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; min-width: 520px;">
          <thead>
            <tr>
              <th align="left">Puzzle ID</th>
              <th align="left">Players</th>
              <th align="left">Others</th>
              <th align="left">Expected Turns</th>
              <th align="left">Started</th>
              <th align="left">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for s in active_sessions %}
              <tr>
                <td>{{ s.puzzle_id }}</td>
                <td>{{ s.players_count }}</td>
                <td>{% if s.others and s.others|length > 0 %}{{ s.others|join(', ') }}{% else %}-{% endif %}</td>
                <td>{{ s.expected_turns }}</td>
                <td>{{ s.started_at }}</td>
                <td><a href="/quick?session_id={{ s.session_id }}">Resume</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endif %}

    {% if not requested %}
      <!-- <p>Choose filters and hit Go to get a puzzle.</p> -->
    {% elif not puzzle %}
      <p>No puzzles found. Generate them first.</p>
    {% else %}
      <p><a href="/quick">← Back</a></p>
      <p><strong>Puzzle ID:</strong> {{ puzzle.id }} | <strong>Players:</strong> {{ puzzle.players }} | <strong>Level:</strong> {{ puzzle.level }}</p>
      <p><strong>Turns to solve in:</strong> {{ expected_turns }}{% if solve_pct is not none %} | <strong>Solve%:</strong> {{ '%.1f'|format(solve_pct) }}%{% endif %}</p>
      <div class="grid">
        {% set rows = layout.rows %}
        {% set row_res = layout.row_reserves %}
        {% set col_res = layout.col_reserves %}
        {% set opp = layout.opponent_row_index %}
        
        <!-- Column reserves (Bottom) shown at top with tooltip -->
        <div class="row">
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve bottom">{{ col_res[c][1] }}</div>
          {% endfor %}
        </div>
        
        <!-- Column reserves (Top) shown at top with tooltip -->
        <div class="row">
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve top">{{ col_res[c][0] }}</div>
          {% endfor %}
        </div>


        {% for r in range(rows|length) %}
          <div class="row">
            <div class="cell reserve" title="Row reserve bottom">{{ row_res[r][1] }}</div>
            <div class="cell reserve" title="Row reserve top">{{ row_res[r][0] }}</div>
            {% for c in range(5) %}
              <div class="cell {% if r==opp %}opponent{% endif %}">{{ rows[r][c] }}</div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <form method="post" action="/report">
        <input type="hidden" name="puzzle_id" value="{{ puzzle.id }}" />
        {% if session_id %}<input type="hidden" name="session_id" value="{{ session_id }}" />{% endif %}
        {% if turns_filter %}<input type="hidden" name="turns_filter" value="{{ turns_filter }}" />{% endif %}
        <label>
          <input type="checkbox" name="solved" value="1" /> Solved
        </label>
        <button type="submit">Submit</button>
      </form>
      {% if session_id %}
      <div style="margin-top:8px;">
        <button id="quick-give-up-btn" style="padding:4px 8px; background:#f7e0e0; border:1px solid #e0b0b0; border-radius:4px;">Give Up</button>
      </div>
      <!-- Solution steps modal -->
      <div id="quick-solution-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.4); z-index: 9999;">
        <div style="background:#fff; width: 520px; max-width: 95vw; margin: 8% auto; padding: 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0;">Solution Steps</h3>
            <button id="quick-solution-modal-close" style="padding:4px 8px;">Close</button>
          </div>
          <div id="quick-solution-steps">
            <p>Loading steps…</p>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}
  {% endif %}
  <script type="module">
    // Define a global to refresh party after accepting invite from header
    window.refreshParty = async function refreshParty() {
      try {
        const r = await fetch('/api/party');
        if (!r.ok) return;
        const j = await r.json();
        if (!j || !j.ok) return;
        const party = j.party || [];
        const playersCountEl = document.getElementById('players-count');
        const list = document.getElementById('party-list');
        if (playersCountEl) playersCountEl.textContent = String(j.players_count || (1 + party.length));
        if (list) {
          if (party.length === 0) {
            // list.innerHTML = '<p style="margin:6px 0 0 0;">Only you for now. Invite teammates with the button above.</p>';
          } else {
            const ul = document.createElement('ul');
            ul.style.margin = '0';
            ul.style.paddingLeft = '18px';
            const liYou = document.createElement('li');
            liYou.innerHTML = '<em>You</em>';
            ul.appendChild(liYou);
            party.forEach((m) => {
              const li = document.createElement('li');
              li.textContent = m.display_name;
              ul.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(ul);
          }
        }
      } catch (_) {}
    };

    const inviteAddBtn = document.getElementById('invite-add-btn');
    const inviteMsg = document.getElementById('invite-msg');
    if (inviteAddBtn) {
      inviteAddBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = prompt('Invite player by user ID code (e.g., ABC234):');
        if (!code) return;
        try {
          const r = await fetch('/api/invites/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_code: code }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            if (inviteMsg) inviteMsg.textContent = 'Invite sent. Expires in 5 minutes.';
          } else {
            const err = j && j.error ? j.error : 'failed';
            if (inviteMsg) inviteMsg.textContent = 'Invite ' + err + '.';
          }
        } catch (_) {
          if (inviteMsg) inviteMsg.textContent = 'Network error sending invite.';
        }
      });
    }
  </script>
  <script type="module">
    const quickGiveUpBtn = document.getElementById('quick-give-up-btn');
    const quickSolutionModal = document.getElementById('quick-solution-modal');
    const quickSolutionSteps = document.getElementById('quick-solution-steps');
    const quickSolutionModalClose = document.getElementById('quick-solution-modal-close');
    if (quickSolutionModalClose && quickSolutionModal) {
      quickSolutionModalClose.addEventListener('click', () => {
        quickSolutionModal.style.display = 'none';
        location.href = '/quick';
      });
    }
    if (quickGiveUpBtn) {
      quickGiveUpBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Give up and end this quick play puzzle?')) return;
        try {
          const sessionIdInput = document.querySelector('input[name="session_id"]');
          const sessionId = sessionIdInput ? Number(sessionIdInput.value) : null;
          if (!sessionId) return;
          if (quickSolutionSteps) quickSolutionSteps.innerHTML = '<p>Loading steps…</p>';
          const r = await fetch('/quick/give_up', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            const steps = Array.isArray(j.steps) ? j.steps : [];
            if (quickSolutionSteps) {
              if (steps.length > 0) {
                const ol = document.createElement('ol');
                steps.forEach((s) => {
                  const li = document.createElement('li');
                  li.textContent = s;
                  ol.appendChild(li);
                });
                quickSolutionSteps.innerHTML = '';
                quickSolutionSteps.appendChild(ol);
              } else {
                quickSolutionSteps.innerHTML = '<p>No steps available.</p>';
              }
            }
            if (quickSolutionModal) quickSolutionModal.style.display = 'block';
          } else {
            alert('Failed to give up.');
          }
        } catch (_) {
          alert('Network error.');
        }
      });
    }
  </script>
{% endblock %}
