{% extends 'base.html' %}
{% block content %}
  <h2>Quick Play</h2>

  {% if require_login %}
    <p>You must sign in to play. Use the "Sign in with Google" button in the top-right.</p>
  {% else %}
    {% if not puzzle %}
      <form method="get" action="/quick">
        <label for="turns">Turns:</label>
        <input id="turns" name="turns" type="number" min="1" value="{{ turns_filter if turns_filter is not none else '' }}" placeholder="Random" />
        <input type="hidden" name="go" value="1" />
        <button type="submit">Go</button>
      </form>

      <div style="margin-top:12px; padding:8px; background:#f7f7f7; border:1px solid #ddd; border-radius:4px; max-width:520px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <strong>Players:</strong> <span id="players-count">{{ players_count }}</span>
          </div>
          <div>
            <button id="invite-add-btn" title="Invite by user ID code" style="padding:4px 8px;">+ Invite</button>
          </div>
        </div>
        <div id="party-list" style="margin-top:8px;">
          {% if party and party|length > 0 %}
            <ul style="margin:0; padding-left:18px;">
              <li><em>You</em></li>
              {% for m in party %}
                <li>{{ m.display_name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <!-- <p style="margin:6px 0 0 0;">Only you for now. Invite teammates with the button above.</p> -->
          {% endif %}
        </div>
        <div id="invite-msg" style="margin-top:6px; color:#333;"></div>
      </div>

      {% if active_sessions and active_sessions|length > 0 %}
        <h3 style="margin-top:18px;">Resume a puzzle</h3>
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; min-width: 520px;">
          <thead>
            <tr>
              <th align="left">Puzzle ID</th>
              <th align="left">Players</th>
              <th align="left">Others</th>
              <th align="left">Expected Turns</th>
              <th align="left">Started</th>
              <th align="left">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for s in active_sessions %}
              <tr>
                <td>{{ s.puzzle_id }}</td>
                <td>{{ s.players_count }}</td>
                <td>{% if s.others and s.others|length > 0 %}{{ s.others|join(', ') }}{% else %}-{% endif %}</td>
                <td>{{ s.expected_turns }}</td>
                <td>{{ s.started_at }}</td>
                <td><a href="/quick?session_id={{ s.session_id }}">Resume</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endif %}

    {% if not requested %}
      <!-- <p>Choose filters and hit Go to get a puzzle.</p> -->
    {% elif not puzzle %}
      <p>No puzzles found. Generate them first.</p>
    {% else %}
      <p><a href="/quick">← Back</a></p>
      <p><strong>Puzzle ID:</strong> {{ puzzle.id }} | <strong>Players:</strong> {{ puzzle.players }} | <strong>Level:</strong> {{ puzzle.level }}</p>
      <p><strong>Turns to solve in:</strong> {{ expected_turns }}{% if solve_pct is not none %} | <strong>Solve%:</strong> {{ '%.1f'|format(solve_pct) }}%{% endif %}</p>
      <div class="grid">
        {% set rows = layout.rows %}
        {% set row_res = layout.row_reserves %}
        {% set col_res = layout.col_reserves %}
        {% set opp = layout.opponent_row_index %}
        
        <!-- Column reserves (Bottom) shown at top with tooltip -->
        <div class="row">
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve bottom">{{ col_res[c][1] }}</div>
          {% endfor %}
        </div>
        
        <!-- Column reserves (Top) shown at top with tooltip -->
        <div class="row">
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve top">{{ col_res[c][0] }}</div>
          {% endfor %}
        </div>


        {% for r in range(rows|length) %}
          <div class="row">
            <div class="cell reserve" title="Row reserve bottom">{{ row_res[r][1] }}</div>
            <div class="cell reserve" title="Row reserve top">{{ row_res[r][0] }}</div>
            {% for c in range(5) %}
              <div class="cell {% if r==opp %}opponent{% endif %}">{{ rows[r][c] }}</div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <form method="post" action="/report">
        <input type="hidden" name="puzzle_id" value="{{ puzzle.id }}" />
        {% if session_id %}<input type="hidden" name="session_id" value="{{ session_id }}" />{% endif %}
        {% if turns_filter %}<input type="hidden" name="turns_filter" value="{{ turns_filter }}" />{% endif %}
        <label>
          <input type="checkbox" name="solved" value="1" /> Solved
        </label>
        <button type="submit">Submit</button>
      </form>
      {% if session_id %}
      <div style="margin-top:8px;">
        <button id="quick-give-up-btn" style="padding:4px 8px; background:#f7e0e0; border:1px solid #e0b0b0; border-radius:4px;">Give Up</button>
      </div>
      <!-- Solution steps modal -->
      <div id="quick-solution-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.4); z-index: 9999;">
        <div style="background:#fff; width: 520px; max-width: 95vw; margin: 8% auto; padding: 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0;">Solution</h3>
            <button id="quick-solution-modal-close" style="padding:4px 8px;">Close</button>
          </div>
          <div id="quick-solution-initial" style="margin-bottom:10px;"></div>
          <div id="quick-solution-steps">
            <p>Loading steps…</p>
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}
  {% endif %}
  <script type="module">
    // Define a global to refresh party after accepting invite from header
    window.refreshParty = async function refreshParty() {
      try {
        const r = await fetch('/api/party');
        if (!r.ok) return;
        const j = await r.json();
        if (!j || !j.ok) return;
        const party = j.party || [];
        const playersCountEl = document.getElementById('players-count');
        const list = document.getElementById('party-list');
        if (playersCountEl) playersCountEl.textContent = String(j.players_count || (1 + party.length));
        if (list) {
          if (party.length === 0) {
            // list.innerHTML = '<p style="margin:6px 0 0 0;">Only you for now. Invite teammates with the button above.</p>';
          } else {
            const ul = document.createElement('ul');
            ul.style.margin = '0';
            ul.style.paddingLeft = '18px';
            const liYou = document.createElement('li');
            liYou.innerHTML = '<em>You</em>';
            ul.appendChild(liYou);
            party.forEach((m) => {
              const li = document.createElement('li');
              li.textContent = m.display_name;
              ul.appendChild(li);
            });
            list.innerHTML = '';
            list.appendChild(ul);
          }
        }
      } catch (_) {}
    };

    const inviteAddBtn = document.getElementById('invite-add-btn');
    const inviteMsg = document.getElementById('invite-msg');
    if (inviteAddBtn) {
      inviteAddBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = prompt('Invite player by user ID code (e.g., ABC234):');
        if (!code) return;
        try {
          const r = await fetch('/api/invites/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_code: code }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            if (inviteMsg) inviteMsg.textContent = 'Invite sent. Expires in 5 minutes.';
          } else {
            const err = j && j.error ? j.error : 'failed';
            if (inviteMsg) inviteMsg.textContent = 'Invite ' + err + '.';
          }
        } catch (_) {
          if (inviteMsg) inviteMsg.textContent = 'Network error sending invite.';
        }
      });
    }
  </script>
  <script type="module">
    const quickGiveUpBtn = document.getElementById('quick-give-up-btn');
    const quickSolutionModal = document.getElementById('quick-solution-modal');
    const quickSolutionSteps = document.getElementById('quick-solution-steps');
    const quickSolutionInitial = document.getElementById('quick-solution-initial');
    const quickSolutionModalClose = document.getElementById('quick-solution-modal-close');
    if (quickSolutionModalClose && quickSolutionModal) {
      quickSolutionModalClose.addEventListener('click', () => {
        quickSolutionModal.style.display = 'none';
        location.href = '/quick';
      });
    }
    if (quickGiveUpBtn) {
      quickGiveUpBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Give up and end this quick play puzzle?')) return;
        try {
          const sessionIdInput = document.querySelector('input[name="session_id"]');
          const sessionId = sessionIdInput ? Number(sessionIdInput.value) : null;
          if (!sessionId) return;
          if (quickSolutionSteps) quickSolutionSteps.innerHTML = '<p>Loading steps…</p>';
          const r = await fetch('/quick/give_up', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            const steps = Array.isArray(j.steps) ? j.steps : [];
            const layout = j.layout || null;
            if (quickSolutionInitial) {
              if (layout && layout.rows && layout.row_reserves && layout.col_reserves) {
                // Render initial layout using same grid markup
                const rows = layout.rows;
                const row_res = layout.row_reserves;
                const col_res = layout.col_reserves;
                const opp = layout.opponent_row_index;
                const container = document.createElement('div');
                const title = document.createElement('div');
                title.innerHTML = '<strong>Initial Setup</strong>';
                title.style.marginBottom = '6px';
                container.appendChild(title);
                const grid = document.createElement('div');
                grid.className = 'grid';
                function makeRow(cells) {
                  const row = document.createElement('div');
                  row.className = 'row';
                  cells.forEach((html) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.innerHTML = html;
                    row.appendChild(cell);
                  });
                  return row;
                }
                // Bottom reserves row displayed first (matches page)
                {
                  const cells = ['&nbsp;','&nbsp;'];
                  for (let c = 0; c < 5; c++) cells.push(String(col_res[c][1] ?? ''));
                  grid.appendChild(makeRow(cells));
                }
                // Top reserves row
                {
                  const cells = ['&nbsp;','&nbsp;'];
                  for (let c = 0; c < 5; c++) cells.push(String(col_res[c][0] ?? ''));
                  grid.appendChild(makeRow(cells));
                }
                // Main rows
                for (let r = 0; r < rows.length; r++) {
                  const rowDiv = document.createElement('div');
                  rowDiv.className = 'row';
                  // prepend two reserve cells
                  const resBot = document.createElement('div'); resBot.className = 'cell reserve'; resBot.textContent = String(row_res[r][1] ?? '');
                  const resTop = document.createElement('div'); resTop.className = 'cell reserve'; resTop.textContent = String(row_res[r][0] ?? '');
                  rowDiv.appendChild(resBot);
                  rowDiv.appendChild(resTop);
                  for (let cc = 0; cc < 5; cc++) {
                    const gc = document.createElement('div');
                    gc.className = 'cell' + (r === opp ? ' opponent' : '');
                    gc.textContent = String(rows[r][cc] ?? '');
                    rowDiv.appendChild(gc);
                  }
                  grid.appendChild(rowDiv);
                }
                quickSolutionInitial.innerHTML = '';
                quickSolutionInitial.appendChild(title);
                quickSolutionInitial.appendChild(grid);
              } else {
                quickSolutionInitial.innerHTML = '';
              }
            }
            if (quickSolutionSteps) {
              if (steps.length > 0) {
                const ol = document.createElement('ol');
                steps.forEach((s) => {
                  const li = document.createElement('li');
                  li.textContent = s;
                  ol.appendChild(li);
                });
                quickSolutionSteps.innerHTML = '';
                quickSolutionSteps.appendChild(ol);
              } else {
                quickSolutionSteps.innerHTML = '<p>No steps available.</p>';
              }
            }
            if (quickSolutionModal) quickSolutionModal.style.display = 'block';
          } else {
            alert('Failed to give up.');
          }
        } catch (_) {
          alert('Network error.');
        }
      });
    }
  </script>
{% endblock %}
