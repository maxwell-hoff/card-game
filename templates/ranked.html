{% extends 'base.html' %}
{% block content %}
  <h2>Ranked</h2>

  {% if require_login %}
    <p>You must sign in to play. Use the "Sign in with Google" button in the top-right.</p>
  {% else %}
    <p><strong>Your Ranked ELO:</strong> {% if elo is not none %}{{ '%.0f'|format(elo) }}{% else %}-{% endif %}</p>
    {% if not puzzle %}
      {% set has_active = active_sessions and active_sessions|length > 0 %}
      <form method="get" action="/ranked">
        <input type="hidden" name="go" value="1" />
        <button id="go-top-btn" type="submit" {% if has_active %}disabled title="You have an active ranked puzzle. Complete or give up first." style="opacity:0.6; cursor:not-allowed;"{% endif %}>Find Match</button>
      </form>
      {% if has_active %}
        <div style="margin-top:6px; color:#666; font-size: 90%;">Complete your current ranked puzzle to find a new match.</div>
      {% endif %}

      <div style="margin-top:12px; padding:8px; background:#f7f7f7; border:1px solid #ddd; border-radius:4px; max-width:520px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <strong>Players:</strong> <span id="players-count">{{ players_count }}</span>
          </div>
          <div>
            <button id="invite-add-btn" title="Invite by user ID code" style="padding:4px 8px;">+ Invite</button>
          </div>
        </div>
        <div id="party-list" style="margin-top:8px;">
          {% if party and party|length > 1 %}
            <ul id="party-ul" style="margin:0; padding-left:18px;"></ul>
          {% endif %}
        </div>
        <div id="lobby-controls" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button id="ready-toggle" style="padding:4px 8px;">Ready</button>
          <span id="lobby-status" style="color:#555;"></span>
        </div>
        <div id="invite-msg" style="margin-top:6px; color:#333;"></div>
      </div>

      {% if active_sessions and active_sessions|length > 0 %}
        <h3 style="margin-top:18px;">Resume your ranked puzzle</h3>
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; min-width: 520px;">
          <thead>
            <tr>
              <th align="left">Puzzle ID</th>
              <th align="left">Players</th>
              <th align="left">Others</th>
              <th align="left">Expected Turns</th>
              <th align="left">Started</th>
              <th align="left">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for s in active_sessions %}
              <tr>
                <td>{{ s.puzzle_id }}</td>
                <td>{{ s.players_count }}</td>
                <td>{% if s.others and s.others|length > 0 %}{{ s.others|join(', ') }}{% else %}-{% endif %}</td>
                <td>{{ s.expected_turns }}</td>
                <td>{{ s.started_at }}</td>
                <td><a href="/ranked?session_id={{ s.session_id }}">Resume</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endif %}

    {% if requested and puzzle %}
      <p><a href="/ranked">← Back</a></p>
      <p><strong>Puzzle ID:</strong> {{ puzzle.id }} | <strong>Players:</strong> {{ puzzle.players }} | <strong>Level:</strong> {{ puzzle.level }}</p>
      <p><strong>Turns to solve in:</strong> {{ expected_turns }}{% if solve_pct is not none %} | <strong>Solve%:</strong> {{ '%.1f'|format(solve_pct) }}%{% endif %}</p>
      <div class="grid">
        {% set rows = layout.rows %}
        {% set row_res = layout.row_reserves %}
        {% set col_res = layout.col_reserves %}
        {% set opp = layout.opponent_row_index %}

        <div class="row">
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          <div class="cell reserve" title="Column reserve bottom">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve bottom">{{ col_res[c][1] }}</div>
          {% endfor %}
        </div>

        <div class="row">
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          <div class="cell reserve" title="Column reserve top">&nbsp;</div>
          {% for c in range(5) %}
            <div class="cell reserve" title="Column reserve top">{{ col_res[c][0] }}</div>
          {% endfor %}
        </div>

        {% for r in range(rows|length) %}
          <div class="row">
            <div class="cell reserve" title="Row reserve bottom">{{ row_res[r][1] }}</div>
            <div class="cell reserve" title="Row reserve top">{{ row_res[r][0] }}</div>
            {% for c in range(5) %}
              <div class="cell {% if r==opp %}opponent{% endif %}">{{ rows[r][c] }}</div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <form method="post" action="/report" style="margin-top:8px;">
        <input type="hidden" name="puzzle_id" value="{{ puzzle.id }}" />
        {% if session_id %}<input type="hidden" name="session_id" value="{{ session_id }}" />{% endif %}
        <label>
          <input type="checkbox" name="solved" value="1" /> Solved
        </label>
        <button type="submit">Submit</button>
      </form>

      {% if session_id %}
      <div style="margin-top:8px;">
        <button id="give-up-btn" style="padding:4px 8px; background:#f7e0e0; border:1px solid #e0b0b0; border-radius:4px;">Give Up</button>
      </div>
      <!-- Solution modal -->
      <div id="solution-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.4); z-index: 9999;">
        <div style="background:#fff; width: 520px; max-width: 95vw; margin: 8% auto; padding: 16px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0;">Solution</h3>
            <button id="solution-modal-close" style="padding:4px 8px;">Close</button>
          </div>
          <div id="solution-initial" style="margin-bottom:10px;"></div>
          <div id="solution-steps">
            <p>Loading…</p>
          </div>
        </div>
      </div>
      {% endif %}
    {% elif requested and not puzzle %}
      <p>No ranked puzzle found. Try again later.</p>
      {% if note %}<p>{{ note }}</p>{% endif %}
    {% endif %}
  {% endif %}

  <script type="module">
    // Poll session status so all players exit when any finishes
    (function sessionStatusPolling(){
      const sessionIdInput = document.querySelector('input[name="session_id"]');
      const sid = sessionIdInput ? Number(sessionIdInput.value) : null;
      if (!sid) return;
      let timer = null;
      async function poll() {
        try {
          const r = await fetch(`/api/game_session/status?session_id=${sid}`);
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            const paused = window.__SESSION_POLL_PAUSED__ === true;
            if (j.status === 'completed' && !paused) {
              location.href = '/ranked';
              return;
            }
          }
        } catch (_) {}
        timer = setTimeout(poll, 3000);
      }
      poll();
      window.addEventListener('beforeunload', () => { if (timer) clearTimeout(timer); });
    })();
    // Invite helpers reused from quick
    window.refreshParty = async function refreshParty() {
      try {
        const r = await fetch('/api/party?mode=ranked');
        if (!r.ok) return;
        const j = await r.json();
        if (!j || !j.ok) return;
        const party = j.party || [];
        const playersCountEl = document.getElementById('players-count');
        const list = document.getElementById('party-list');
        if (playersCountEl) playersCountEl.textContent = String(j.players_count || (1 + party.length));
        if (list) {
          if (party.length <= 1) {
            list.innerHTML = '';
          } else {
            const ul = document.createElement('ul');
            ul.id = 'party-ul';
            ul.style.margin = '0';
            ul.style.paddingLeft = '18px';
            list.innerHTML = '';
            list.appendChild(ul);
          }
        }
      } catch (_) {}
    };

    // Lobby polling for readiness/state
    (function initLobbyPolling() {
      const readyBtn = document.getElementById('ready-toggle');
      const goTopBtn = document.getElementById('go-top-btn');
      const lobbyStatus = document.getElementById('lobby-status');
      let isReady = false;
      let pollTimer = null;

      function renderReadyPills(party) {
        const pills = document.querySelectorAll('.ready-pill');
        pills.forEach((pill) => {
          const attr = pill.getAttribute('data-user');
          const uid = attr === 'self' ? window.__SESSION_USER_ID__ : attr;
          const matching = party.find(p => String(p.user_id) === String(uid));
          const ready = matching ? !!matching.ready : false;
          pill.textContent = ready ? '✓ ready' : 'not ready';
          pill.style.fontSize = '90%';
          pill.style.color = ready ? '#0a0' : '#a00';
          pill.style.marginLeft = '6px';
        });
      }

      function renderParty(party) {
        let ul = document.getElementById('party-ul');
        if (party.length <= 1) { if (ul) ul.innerHTML=''; return; }
        if (!ul) {
          const list = document.getElementById('party-list');
          if (!list) return;
          ul = document.createElement('ul');
          ul.id = 'party-ul';
          ul.style.margin = '0';
          ul.style.paddingLeft = '18px';
          list.innerHTML = '';
          list.appendChild(ul);
        }
        ul.innerHTML = '';
        party.forEach((m) => {
          const li = document.createElement('li');
          const nameSpan = document.createElement('span');
          nameSpan.textContent = m.display_name + ' ';
          li.appendChild(nameSpan);
          const pill = document.createElement('span');
          pill.className = 'ready-pill';
          pill.setAttribute('data-user', String(m.user_id));
          li.appendChild(pill);
          const myId = window.__SESSION_USER_ID__;
          // Host can kick others
          if (party.length > 1 && myId && m.user_id !== myId) {
            const hostId = party[0]?.user_id;
            if (myId === hostId) {
              const btn = document.createElement('button');
              btn.textContent = '−';
              btn.title = 'Remove from lobby';
              btn.style.marginLeft = '8px';
              btn.style.padding = '0 6px';
              btn.addEventListener('click', async (e) => {
                e.preventDefault();
                if (!confirm(`Remove ${m.display_name} from the lobby?`)) return;
                try {
                  const r = await fetch('/api/lobby/kick', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'ranked', user_id: m.user_id }) });
                  const j = await r.json().catch(() => null);
                  if (j && j.ok) fetchStatus();
                } catch (_) {}
              });
              li.appendChild(btn);
            }
          }
          // Invitees can leave
          if (party.length > 1 && myId && m.user_id === myId && myId !== party[0]?.user_id) {
            const leaveBtn = document.createElement('button');
            leaveBtn.textContent = 'Leave';
            leaveBtn.style.marginLeft = '8px';
            leaveBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              try {
                const r = await fetch('/api/lobby/leave', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'ranked' }) });
                const j = await r.json().catch(() => null);
                if (j && j.ok) {
                  location.href = '/ranked';
                }
              } catch (_) {}
            });
            li.appendChild(leaveBtn);
          }
          ul.appendChild(li);
        });
      }

      async function fetchStatus() {
        try {
          const r = await fetch('/api/lobby/status?mode=ranked');
          const j = await r.json().catch(() => null);
          if (!j || !j.ok) return;
          const party = Array.isArray(j.party) ? j.party : [];
          // Hide ready UI when solo
          const controls = document.getElementById('lobby-controls');
          if (controls) controls.style.display = (party.length <= 1) ? 'none' : 'flex';
          renderParty(party);
          if (party.length > 1) renderReadyPills(party);
          if (lobbyStatus) lobbyStatus.textContent = (party.length <= 1) ? '' : (j.can_start ? 'All ready.' : 'Waiting for players…');
          const inviteMsg = document.getElementById('invite-msg');
          if (inviteMsg && party.length > 1) inviteMsg.textContent = '';
          if (goTopBtn && !goTopBtn.hasAttribute('disabled')) {
            const disable = !(j && j.can_start);
            goTopBtn.disabled = disable;
            goTopBtn.style.opacity = disable ? '0.6' : '';
            goTopBtn.style.cursor = disable ? 'not-allowed' : '';
            goTopBtn.title = disable ? 'All players must be ready' : '';
          }
          // If a session exists for this lobby, redirect everyone to it
          const currentSessionInput = document.querySelector('input[name="session_id"]');
          const currentSessionId = currentSessionInput ? Number(currentSessionInput.value) : null;
          if (j.active_session_id && (!currentSessionId || Number(j.active_session_id) !== currentSessionId)) {
            location.href = '/ranked?session_id=' + String(j.active_session_id);
            return;
          }
        } catch (_) {}
        finally {
          pollTimer = setTimeout(fetchStatus, 3000);
        }
      }

      async function setReadyState(flag) {
        try {
          await fetch('/api/lobby/ready', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'ranked', ready: !!flag }) });
        } catch (_) {}
      }

      // Ensure default is unready on load and when returning via back/forward cache
      setReadyState(false);
      window.addEventListener('pageshow', () => { setReadyState(false); });

      if (readyBtn) {
        readyBtn.addEventListener('click', async () => {
          isReady = !isReady;
          readyBtn.textContent = isReady ? 'Unready' : 'Ready';
          setReadyState(isReady);
          fetchStatus();
        });
      }
      // Intercept top Find Match to use lobby start in party
      if (goTopBtn && !goTopBtn.hasAttribute('disabled')) {
        const form = goTopBtn.closest('form');
        if (form) {
          form.addEventListener('submit', async (e) => {
            try {
              const r = await fetch('/api/lobby/status?mode=ranked');
              const j = await r.json().catch(() => null);
              const partyLen = (j && j.ok && Array.isArray(j.party)) ? j.party.length : 1;
              if (partyLen > 1) {
                e.preventDefault();
                const rs = await fetch('/api/lobby/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'ranked' }) });
                const sr = await rs.json().catch(() => null);
                if (sr && sr.ok && sr.redirect_url) {
                  location.href = sr.redirect_url;
                }
                return;
              }
            } catch (_) { /* fall through to normal submit */ }
          });
        }
      }
      fetchStatus();
    })();

    const inviteAddBtn = document.getElementById('invite-add-btn');
    const inviteMsg = document.getElementById('invite-msg');
    if (inviteAddBtn) {
      inviteAddBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = prompt('Invite player by user ID code (e.g., ABC234):');
        if (!code) return;
        try {
          const r = await fetch('/api/invites/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_code: code, mode: 'ranked' }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            if (inviteMsg) {
              inviteMsg.textContent = 'Invite sent. Expires in 5 minutes.';
              setTimeout(() => { inviteMsg.textContent = ''; }, 5000);
            }
          } else {
            const err = j && j.error ? j.error : 'failed';
            if (inviteMsg) inviteMsg.textContent = 'Invite ' + err + '.';
          }
        } catch (_) {
          if (inviteMsg) inviteMsg.textContent = 'Network error sending invite.';
        }
      });
    }

    const giveUpBtn = document.getElementById('give-up-btn');
    const solutionModal = document.getElementById('solution-modal');
    const solutionSteps = document.getElementById('solution-steps');
    const solutionInitial = document.getElementById('solution-initial');
    const solutionModalClose = document.getElementById('solution-modal-close');
    if (solutionModalClose && solutionModal) {
      solutionModalClose.addEventListener('click', () => {
        solutionModal.style.display = 'none';
        try { window.__SESSION_POLL_PAUSED__ = false; } catch (_) {}
        // After viewing solution, return to ranked home so player can find a new match
        location.href = '/ranked';
      });
    }
    if (giveUpBtn) {
      giveUpBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Give up and record a loss for this ranked puzzle?')) return;
        try {
          const sessionIdInput = document.querySelector('input[name="session_id"]');
          const sessionId = sessionIdInput ? Number(sessionIdInput.value) : null;
          if (!sessionId) return;
          if (solutionSteps) solutionSteps.innerHTML = '<p>Loading steps…</p>';
          const r = await fetch('/ranked/give_up', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
          const j = await r.json().catch(() => null);
          if (j && j.ok) {
            const steps = Array.isArray(j.steps) ? j.steps : [];
            const layout = j.layout || null;
            if (solutionInitial) {
              if (layout && layout.rows && layout.row_reserves && layout.col_reserves) {
                // Render initial layout using same grid markup
                const rows = layout.rows;
                const row_res = layout.row_reserves;
                const col_res = layout.col_reserves;
                const opp = layout.opponent_row_index;
                const container = document.createElement('div');
                const title = document.createElement('div');
                title.innerHTML = '<strong>Initial Setup</strong>';
                title.style.marginBottom = '6px';
                container.appendChild(title);
                const grid = document.createElement('div');
                grid.className = 'grid';
                // Bottom reserves row
                {
                  const row = document.createElement('div'); row.className = 'row';
                  let cell = document.createElement('div'); cell.className = 'cell reserve'; cell.innerHTML = '&nbsp;'; row.appendChild(cell);
                  cell = document.createElement('div'); cell.className = 'cell reserve'; cell.innerHTML = '&nbsp;'; row.appendChild(cell);
                  for (let c = 0; c < 5; c++) { const d = document.createElement('div'); d.className = 'cell reserve'; d.textContent = String(col_res[c][1] ?? ''); row.appendChild(d); }
                  grid.appendChild(row);
                }
                // Top reserves row
                {
                  const row = document.createElement('div'); row.className = 'row';
                  let cell = document.createElement('div'); cell.className = 'cell reserve'; cell.innerHTML = '&nbsp;'; row.appendChild(cell);
                  cell = document.createElement('div'); cell.className = 'cell reserve'; cell.innerHTML = '&nbsp;'; row.appendChild(cell);
                  for (let c = 0; c < 5; c++) { const d = document.createElement('div'); d.className = 'cell reserve'; d.textContent = String(col_res[c][0] ?? ''); row.appendChild(d); }
                  grid.appendChild(row);
                }
                // Main rows
                for (let rr = 0; rr < rows.length; rr++) {
                  const row = document.createElement('div'); row.className = 'row';
                  const resBot = document.createElement('div'); resBot.className = 'cell reserve'; resBot.textContent = String(row_res[rr][1] ?? ''); row.appendChild(resBot);
                  const resTop = document.createElement('div'); resTop.className = 'cell reserve'; resTop.textContent = String(row_res[rr][0] ?? ''); row.appendChild(resTop);
                  for (let cc = 0; cc < 5; cc++) {
                    const d = document.createElement('div'); d.className = 'cell' + (rr === opp ? ' opponent' : ''); d.textContent = String(rows[rr][cc] ?? ''); row.appendChild(d);
                  }
                  grid.appendChild(row);
                }
                solutionInitial.innerHTML = '';
                solutionInitial.appendChild(title);
                solutionInitial.appendChild(grid);
              } else {
                solutionInitial.innerHTML = '';
              }
            }
            if (solutionSteps) {
              if (steps.length > 0) {
                const ol = document.createElement('ol');
                steps.forEach((s) => {
                  const li = document.createElement('li');
                  li.textContent = s;
                  ol.appendChild(li);
                });
                solutionSteps.innerHTML = '';
                solutionSteps.appendChild(ol);
              } else {
                solutionSteps.innerHTML = '<p>No steps available.</p>';
              }
            }
            if (solutionModal) { window.__SESSION_POLL_PAUSED__ = true; solutionModal.style.display = 'block'; }
          } else {
            alert('Failed to give up.');
          }
        } catch (_) {
          alert('Network error.');
        }
      });
    }
  </script>
{% endblock %}
